<style>
    .reaction-picker {
        display: none;
        flex-direction: row;
        gap: 5px;
        padding: 5px;
        background: #2c2f33;
        border-radius: 5px;
        position: absolute;
        z-index: 1000;
    }

        .reaction-picker[style*="display: flex"] {
            display: flex !important;
        }

    .reaction-option {
        cursor: pointer;
        font-size: 20px;
        padding: 5px;
    }

        .reaction-option:hover {
            background: #40444b;
            border-radius: 3px;
        }

    /* ‚òÖ DODANE ‚Äì plusik */
    .file-upload-btn {
        cursor: pointer;
        font-size: 22px;
        padding: 6px 10px;
        margin-right: 6px;
        background: #40444b;
        border-radius: 6px;
        color: #fff;
        display: flex;
        align-items: center;
    }

        .file-upload-btn:hover {
            background: #5865f2;
        }

    /* ‚òÖ DODANE ‚Äì preview */
    .image-preview {
        position: relative;
        margin-top: 6px;
        max-width: 120px;
    }

        .image-preview img {
            width: 100%;
            border-radius: 6px;
        }

    .remove-preview {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #ff4d4f;
        color: #fff;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
</style>

<div class="chat-container">
    <div id="messagesList" class="messages-area">
        @foreach (var msg in ViewBag.Messages)
        {
            <div class="message-row" data-message-id="@msg.Id">
                <img src="@msg.User.AvatarURL" class="avatar" />
                <div class="message-content">
                    <div class="message-header">
                        <span class="username">@msg.User.Username</span>
                        <span class="timestamp">@msg.CreatedAt.ToString("HH:mm")</span>
                    </div>

                    <div class="message-text">@msg.Value</div>
                    @if (!string.IsNullOrEmpty(msg.ImageUrl))
                    {
                        <div class="image-preview">
                            <img src="@msg.ImageUrl" alt="message image" />
                        </div>
                    }


                    <div class="message-reactions">
                        @foreach (var reaction in msg.Reactions)
                        {
                            var count = reaction.Count;
                            if (count > 0)
                            {
                                var emojiDisplay = reaction.Emoji switch
                                {
                                    "1" => "üëç",
                                    "2" => "‚ù§Ô∏è",
                                    "3" => "üòÇ",
                                    "4" => "üî•",
                                    "5" => "üòé",
                                    _ => reaction.Emoji
                                };
                                <div class="reaction" data-reaction-key="@reaction.Emoji">
                                    @emojiDisplay <span class="count">@count</span>
                                </div>
                            }
                        }
                    </div>

                    <div class="add-reaction-btn">‚ûï</div>

                    <div class="message-actions">
                        <span class="action-button edit-message-btn">‚úèÔ∏è</span>
                        <span class="action-button delete-message-btn">üóëÔ∏è</span>
                    </div>

                    <div class="reaction-picker" style="display:none;">
                        <span class="reaction-option" data-reaction-key="1">üëç</span>
                        <span class="reaction-option" data-reaction-key="2">‚ù§Ô∏è</span>
                        <span class="reaction-option" data-reaction-key="3">üòÇ</span>
                        <span class="reaction-option" data-reaction-key="4">üî•</span>
                        <span class="reaction-option" data-reaction-key="5">üòé</span>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="chat-input-area">
        <input hidden id="channelId" value="@ViewBag.Id" />
        <input hidden id="UserProfileId" value="@ViewBag.UserProfile.Id" />
        <input hidden id="userInput" value="@ViewBag.UserProfile.Username" />

        <!-- ‚òÖ DODANE ‚Äì plusik -->
        <label for="fileInput" class="file-upload-btn">‚ûï</label>
        <input type="file" id="fileInput" accept="image/*" hidden />

        <input type="text" id="messageInput" class="chat-input" placeholder="Wiadomo≈õƒá" />

        <!-- ‚òÖ DODANE ‚Äì preview kontener -->
        <div id="imagePreviewContainer"></div>

        <script>
            document.getElementById("messageInput").addEventListener("keydown", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    document.getElementById("sendBtn").click();
                }
            });


            // ‚òÖ DODANE ‚Äì preview + anulowanie
            const fileInput = document.getElementById("fileInput");
            const previewContainer = document.getElementById("imagePreviewContainer");

            fileInput.addEventListener("change", function () {
                const file = this.files[0];
                if (!file) return;

                if (!file.type.startsWith("image/")) {
                    alert("Tylko zdjƒôcia!");
                    this.value = "";
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    previewContainer.innerHTML = `
                        <div class="image-preview">
                            <img src="${e.target.result}" />
                            <div class="remove-preview">‚úï</div>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            });

            previewContainer.addEventListener("click", function (e) {
                if (e.target.classList.contains("remove-preview")) {
                    previewContainer.innerHTML = "";
                    fileInput.value = "";
                }
            });
            // ‚òÖ KONIEC DODANEGO
        </script>

        <button id="sendBtn" class="chat-send-btn">Wy≈õlij</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script src="~/js/Chathub.js" asp-append-version="true"></script>
