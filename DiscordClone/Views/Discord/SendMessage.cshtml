<div class="chat-container">
    <div id="messagesList" class="messages-area">
        @foreach (var msg in ViewBag.Messages)
        {
            <div class="message-row" data-message-id="@msg.Id">
                <img src="@msg.User.AvatarURL" class="avatar" />

                <div class="message-content">
                    <div class="message-header">
                        <span class="username">@msg.User.Username</span>
                        <span class="timestamp">@msg.CreatedAt.ToString("HH:mm")</span>
                    </div>

                    <div class="message-text">@msg.Value</div>

                    <!-- miejsce na reakcje -->
                    <div class="message-reactions"></div>

                    <!-- ikona dodawania reakcji -->
                    <div class="add-reaction-btn">➕</div>

                    <!-- dodatkowe akcje -->
                    <div class="message-actions">
                        <span class="action-button edit-message-btn">✏️</span>
                        <span class="action-button delete-message-btn">🗑️</span>
                    </div>

                    <!-- popup z reakcjami -->
                    <div class="reaction-picker">
                        <span class="reaction-option">👍</span>
                        <span class="reaction-option">❤️</span>
                        <span class="reaction-option">😂</span>
                        <span class="reaction-option">🔥</span>
                        <span class="reaction-option">😎</span>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="chat-input-area">
        <input hidden id="channelId" value="@ViewBag.Id" />
        <input hidden id="UserProfileId" value="@ViewBag.UserProfile.Id" />
        <input hidden id="userInput" value="@ViewBag.UserProfile.Username" />

        <input type="text" id="messageInput" class="chat-input" placeholder="Wiadomość" />
        <button id="sendBtn" class="chat-send-btn">Wyślij</button>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chathub")
        .build();

    connection.on("ReceiveMessage", (username, message) => {
        const div = document.createElement("div");
        div.innerHTML = `<b>${username}:</b> ${message}`;
        document.getElementById("messagesList").appendChild(div);
    });

    connection.start().catch(err => console.error(err.toString()));

    // -------------------------
    // WYSYŁANIE WIADOMOŚCI
    // -------------------------
    document.getElementById("sendBtn").addEventListener("click", function () {
        const channelId = parseInt(document.getElementById("channelId").value);
        const userId = parseInt(document.getElementById("UserProfileId").value);
        const message = document.getElementById("messageInput").value;

        if (!message) return;

        connection.invoke("SendMessage", channelId, userId, message)
            .catch(err => console.error(err.toString()));

        document.getElementById("messageInput").value = "";
    });

    // -------------------------
    // SYSTEM REAKCJI + EDIT/DELETE
    // -------------------------
    document.querySelectorAll(".message-row").forEach(row => {
        const addBtn = row.querySelector(".add-reaction-btn");
        const picker = row.querySelector(".reaction-picker");
        const reactionsBox = row.querySelector(".message-reactions");

        let pickerOpen = false;

        // Kliknięcie ➕ otwiera panel
        addBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            picker.style.display = "flex";
            pickerOpen = true;
        });

        // Kliknięcie reakcji
        picker.querySelectorAll(".reaction-option").forEach(option => {
            option.addEventListener("click", (e) => {
                e.stopPropagation();
                const emoji = option.textContent;

                // Sprawdź czy reakcja już istnieje
                let existing = reactionsBox.querySelector(`.single-reaction[data-emoji="${emoji}"]`);
                if (existing) {
                    let countSpan = existing.querySelector(".count");
                    countSpan.textContent = parseInt(countSpan.textContent) + 1;
                } else {
                    let span = document.createElement("span");
                    span.classList.add("single-reaction");
                    span.setAttribute("data-emoji", emoji);
                    span.innerHTML = `${emoji} <span class="count">1</span>`;
                    reactionsBox.appendChild(span);
                }

                picker.style.display = "none";
                pickerOpen = false;
            });
        });

        // Kliknięcie poza panelem zamyka go
        document.addEventListener("click", (e) => {
            if (pickerOpen) {
                if (!picker.contains(e.target) && e.target !== addBtn) {
                    picker.style.display = "none";
                    pickerOpen = false;
                }
            }
        });

        // Usuwanie wiadomości
        row.querySelector(".delete-message-btn").addEventListener("click", () => {
            row.remove();
        });

        // Edycja wiadomości
        row.querySelector(".edit-message-btn").addEventListener("click", () => {
            const textDiv = row.querySelector(".message-text");
            const oldText = textDiv.textContent;

            const input = document.createElement("input");
            input.value = oldText;
            input.classList.add("edit-input");

            textDiv.replaceWith(input);
            input.focus();

            input.addEventListener("blur", () => {
                const newDiv = document.createElement("div");
                newDiv.classList.add("message-text");
                newDiv.textContent = input.value;
                input.replaceWith(newDiv);
            });
        });
    });
</script>
