<div class="chat-container">

    <div id="messagesList" class="messages-area">
        @foreach (var msg in ViewBag.Messages)
        {
            <div class="message-row">
                <img src="@msg.User.AvatarURL" class="avatar" />

                <div class="message-content">
                    <div class="message-header">
                        <span class="username">@msg.User.Username</span>
                        <span class="timestamp">@msg.CreatedAt.ToString("HH:mm")</span>
                    </div>

                    <div class="message-text">@msg.Value</div>
                </div>
            </div>
        }
    </div>

    <div class="chat-input-area">
        <input hidden id="channelId" value="@ViewBag.Id" />
        <input hidden id="UserProfileId" value="@ViewBag.UserProfile.Id" />
        <input hidden id="userInput" value="@ViewBag.UserProfile.Username" />

        <input type="text" id="messageInput" class="chat-input" placeholder="Wiadomość" />
        <button id="sendBtn" class="chat-send-btn">Wyślij</button>
    </div>

</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script>
    
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chathub")
        .build();

    connection.on("ReceiveMessage", (username, message) => {
        const div = document.createElement("div");
        div.innerHTML = `<b>${username}:</b> ${message}`;
        document.getElementById("messagesList").appendChild(div);
    });

    // Startujemy połączenie
    connection.start().catch(err => console.error(err.toString()));

    // Obsługa przycisku
    document.getElementById("sendBtn").addEventListener("click", function () {
        const channelId = parseInt(document.getElementById("channelId").value);
        const userId = parseInt(document.getElementById("UserProfileId").value);
        const message = document.getElementById("messageInput").value;

        if (!message) return;

        connection.invoke("SendMessage", channelId, userId, message)
            .catch(err => console.error(err.toString()));

        document.getElementById("messageInput").value = "";
    });
</script>