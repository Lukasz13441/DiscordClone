<style>
    .reaction-picker {
        display: none; /* Hidden by default */
        flex-direction: row;
        gap: 5px;
        padding: 5px;
        background: #2c2f33;
        border-radius: 5px;
        position: absolute;
        z-index: 1000;
    }

        .reaction-picker[style*="display: flex"] {
            display: flex !important;
        }

    .reaction-option {
        cursor: pointer;
        font-size: 20px;
        padding: 5px;
    }

        .reaction-option:hover {
            background: #40444b;
            border-radius: 3px;
        }
</style>


<div class="chat-container">
    <div id="messagesList" class="messages-area">
        @foreach (var msg in ViewBag.Messages)
        {
            <div class="message-row" data-message-id="@msg.Id">
                <img src="@msg.User.AvatarURL" class="avatar" />
                <div class="message-content">
                    <div class="message-header">
                        <span class="username">@msg.User.Username</span>
                        <span class="timestamp">@msg.CreatedAt.ToString("HH:mm")</span>
                    </div>
                    <div class="message-text">@msg.Value</div>

                    <!-- Kontener na reakcje -->
                    <div class="message-reactions">
                        @foreach (var reaction in msg.Reactions)
                        {
                            var count = reaction.Count;
                            if (count > 0)
                            {
                                // Mapowanie klucza reakcji na emoji (MUST MATCH JavaScript REACTION_MAP)
                                var emojiDisplay = reaction.Emoji switch
                                {
                                    "1" => "üëç",
                                    "2" => "‚ù§Ô∏è",
                                    "3" => "üòÇ",
                                    "4" => "üî•",
                                    "5" => "üòé",
                                    _ => reaction.Emoji
                                };
                                <div class="reaction" data-reaction-key="@reaction.Emoji">
                                    @emojiDisplay <span class="count">@count</span>
                                </div>
                            }
                        }
                    </div>

                    <!-- Przycisk dodawania reakcji -->
                    <div class="add-reaction-btn">‚ûï</div>

                    <!-- Akcje (edycja/usuwanie) -->
                    <div class="message-actions">
                        <span class="action-button edit-message-btn">‚úèÔ∏è</span>
                        <span class="action-button delete-message-btn">üóëÔ∏è</span>
                    </div>

                    <!-- Menu wyboru reakcji (MUST USE data-reaction-key) -->
                    <div class="reaction-picker" style="display:none;">
                        <span class="reaction-option" data-reaction-key="1">üëç</span>
                        <span class="reaction-option" data-reaction-key="2">‚ù§Ô∏è</span>
                        <span class="reaction-option" data-reaction-key="3">üòÇ</span>
                        <span class="reaction-option" data-reaction-key="4">üî•</span>
                        <span class="reaction-option" data-reaction-key="5">üòé</span>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="chat-input-area">
        <input hidden id="channelId" value="@ViewBag.Id" />
        <input hidden id="UserProfileId" value="@ViewBag.UserProfile.Id" />
        <input hidden id="userInput" value="@ViewBag.UserProfile.Username" />
        <input type="text" id="messageInput" class="chat-input" placeholder="Wiadomo≈õƒá" />
        <script>
            // Function to scroll to bottom of messages
            function scrollToBottom() {
                const messagesList = document.getElementById("messagesList");
                messagesList.scrollTop = messagesList.scrollHeight;
            }

            // Scroll to bottom on page load
            window.addEventListener('load', function() {
                scrollToBottom();
            });

            // Handle Enter key to send message
            document.getElementById("messageInput").addEventListener("keydown", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault(); // Zapobiega domy≈õlnemu zachowaniu (nowa linia)
                    document.getElementById("sendBtn").click(); // Symuluje klikniƒôcie przycisku Wy≈õlij
                }
            });

            // Handle send button click
            document.getElementById("sendBtn").addEventListener("click", function() {
                // Scroll to bottom after a short delay to allow message to be added
                setTimeout(function() {
                    scrollToBottom();
                }, 100);
            });

            // Optional: Create a MutationObserver to auto-scroll when new messages are added dynamically
            const messagesList = document.getElementById("messagesList");
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length) {
                        scrollToBottom();
                    }
                });
            });

            // Start observing the messagesList for child node additions
            observer.observe(messagesList, { childList: true });
        </script>
        <button id="sendBtn" class="chat-send-btn">Wy≈õlij</button>
    </div>
</div>
<script src="~/js/Chathub.js" asp-append-version="true"></script>