<!-- CHANNEL SIDEBAR HTML -->
<aside class="channel-sidebar">
    <!-- Server Header -->
    <div class="server-header">
        <h4 class="server-title">@ViewBag.Server.Name</h4>
        <a asp-controller="Discord"
           asp-action="ManageServers"
           asp-route-id="@ViewBag.Server.Id"
           class="server-settings-btn"
           title="Server Settings">
            <i class="fa-solid fa-gear"></i>
        </a>
    </div>

    <!-- Channel List -->
    <ul class="channel-list">
        <!-- Text Channels Section -->
        <li class="channel-section-header">TEXT CHANNELS</li>
        @foreach (var channel in ViewBag.Chanels)
        {
            <li class="channel-item">
                <a asp-route-id="@channel.Id"
                   asp-action="SendMessage"
                   class="channel-link">
                    <i class="fa-solid fa-hashtag channel-icon"></i>
                    <span class="channel-name">@channel.Name</span>
                </a>
            </li>
        }

        <!-- Voice Channels Section -->
        <li class="channel-section-header">VOICE CHANNELS</li>
        @foreach (var voiceChannel in ViewBag.VoiceChannels)
        {
            <li class="voice-channel-item" id="voice-channel-@voiceChannel.Id">
                <div class="voice-channel-header"
                     data-voice-id="@voiceChannel.Id"
                     onclick="joinVoiceChannelClick(@voiceChannel.Id, @ViewBag.UserProfile.Id)">
                    <i class="fa-solid fa-volume-high channel-icon"></i>
                    <span class="channel-name">@voiceChannel.Name</span>
                </div>
                <!-- Users container - will be populated by JavaScript -->
                <div class="voice-users-container"></div>
            </li>
        }

        <!-- Add Channel Button -->
        <li class="add-channel">
            <a asp-route-id="@ViewBag.Server.Id"
               asp-action="AddChanel"
               class="add-channel-btn">
                <i class="fa-solid fa-plus"></i>
                <span>Add Channel</span>
            </a>
        </li>
    </ul>

    <!-- Mini Profile -->
    <partial name="mini-profile" />
</aside>

<!-- ============================================ -->
<!-- CSS STYLES -->
<!-- ============================================ -->
<style>
    /* =============================== */
    /*   DISCORD CHANNEL SIDEBAR       */
    /* =============================== */

    .channel-sidebar {
        width: 240px;
        min-width: 240px;
        max-width: 240px;
        background: #2b2d31;
        color: #f2f3f5;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #1e1f22;
        height: 100vh;
        overflow: hidden;
    }

    /* Server Header */
    .server-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 8px;
        border-bottom: 1px solid #1e1f22;
        min-height: 48px;
        box-shadow: 0 1px 0 rgba(4, 4, 5, 0.2);
    }

    .server-title {
        font-size: 16px;
        font-weight: 700;
        color: #f2f3f5;
        margin: 0;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        flex: 1;
        padding-right: 8px;
    }

    .server-settings-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        min-width: 28px;
        border-radius: 4px;
        color: #b5bac1;
        text-decoration: none;
        transition: all 0.15s ease;
        flex-shrink: 0;
    }

        .server-settings-btn:hover {
            background: #35373c;
            color: #f2f3f5;
        }

        .server-settings-btn i {
            font-size: 16px;
        }

    /* Channel List */
    .channel-list {
        list-style: none;
        padding: 8px;
        margin: 0;
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: hidden;
    }

        .channel-list::-webkit-scrollbar {
            width: 8px;
        }

        .channel-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .channel-list::-webkit-scrollbar-thumb {
            background: #1a1b1e;
            border-radius: 4px;
        }

            .channel-list::-webkit-scrollbar-thumb:hover {
                background: #1e1f22;
            }

    /* Section Headers */
    .channel-section-header {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        color: #949ba4;
        padding: 16px 8px 4px 8px;
        letter-spacing: 0.5px;
        margin-top: 8px;
    }

        .channel-section-header:first-child {
            margin-top: 0;
        }

    /* Channel Entry */
    .channel-item {
        margin-bottom: 2px;
    }

    .channel-link {
        display: flex;
        align-items: center;
        padding: 6px 8px;
        border-radius: 4px;
        color: #949ba4;
        text-decoration: none;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.15s ease;
        min-height: 32px;
        cursor: pointer;
    }

        .channel-link:hover {
            background: #35373c;
            color: #dbdee1;
        }

        .channel-link.active {
            background: #404249;
            color: #ffffff;
        }

            .channel-link.active .channel-icon {
                color: #ffffff;
            }

    /* Channel Icon */
    .channel-icon {
        margin-right: 6px;
        font-size: 20px;
        color: #80848e;
        flex-shrink: 0;
        width: 20px;
        text-align: center;
    }

    .channel-name {
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }

    /* Voice Channel Specific */
    .voice-channel-item {
        margin-bottom: 2px;
    }

    .voice-channel-header {
        display: flex;
        align-items: center;
        padding: 6px 8px;
        border-radius: 4px;
        color: #949ba4;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.15s ease;
        min-height: 32px;
        cursor: pointer;
    }

        .voice-channel-header:hover {
            background: #35373c;
            color: #dbdee1;
        }

    /* Voice Users Container */
    .voice-users-container {
        padding-left: 26px;
    }

    .voice-user {
        display: flex;
        align-items: center;
        padding: 4px 8px;
        margin-bottom: 2px;
        border-radius: 4px;
        transition: background 0.15s ease;
    }

        .voice-user:hover {
            background: #35373c;
        }

    .voice-user-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        margin-right: 8px;
        flex-shrink: 0;
        background: #5865f2;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 600;
        color: #fff;
    }

        .voice-user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

    .voice-user-name {
        font-size: 14px;
        color: #b9bbbe;
        font-weight: 500;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }

    /* Add Channel Button */
    .add-channel {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #1e1f22;
    }

    .add-channel-btn {
        display: flex;
        align-items: center;
        padding: 6px 8px;
        border-radius: 4px;
        font-size: 14px;
        color: #949ba4;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.15s ease;
        min-height: 32px;
        gap: 6px;
    }

        .add-channel-btn:hover {
            background: #35373c;
            color: #dbdee1;
        }

        .add-channel-btn i {
            font-size: 16px;
        }

    /* =============================== */
    /*   MINI PROFILE COMPONENT        */
    /* =============================== */

    .mini-profile {
        padding: 8px;
        background: #232428;
        border-top: 1px solid #1e1f22;
        display: flex;
        align-items: center;
        gap: 8px;
        min-height: 52px;
        flex-shrink: 0;
    }

    .mini-profile-avatar {
        width: 32px;
        height: 32px;
        min-width: 32px;
        border-radius: 50%;
        background: #5865f2;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        color: #fff;
        flex-shrink: 0;
        position: relative;
    }

        .mini-profile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

    .mini-profile-status-indicator {
        position: absolute;
        bottom: -2px;
        right: -2px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 2px solid #232428;
        background: #23a55a;
    }

    .mini-profile-info {
        flex: 1;
        min-width: 0;
    }

    .mini-profile-name {
        font-size: 14px;
        font-weight: 600;
        color: #f2f3f5;
        margin: 0;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }

    .mini-profile-status-text {
        font-size: 12px;
        color: #80848e;
        margin: 0;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }

    .mini-profile-actions {
        display: flex;
        gap: 4px;
        flex-shrink: 0;
    }

    .mini-profile-btn {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        background: transparent;
        border: none;
        color: #b5bac1;
        cursor: pointer;
        transition: all 0.15s ease;
    }

        .mini-profile-btn:hover {
            background: #35373c;
            color: #f2f3f5;
        }

        .mini-profile-btn i {
            font-size: 16px;
        }
</style>

<!-- ============================================ -->
<!-- JAVASCRIPT - Add to bottom of page or separate file -->
<!-- ============================================ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script>
    // Connect to VoiceHub
    const voiceConnection = new signalR.HubConnectionBuilder()
        .withUrl("/voiceHub")
        .withAutomaticReconnect()
        .build();

    // Start connection
    voiceConnection.start()
        .then(() => console.log("✅ Connected to VoiceHub"))
        .catch(err => console.error("❌ VoiceHub connection error:", err));

    // Function to join voice channel (called from onclick)
    function joinVoiceChannelClick(voiceChannelId, userId) {
        console.log(`🎤 Joining voice channel ${voiceChannelId}`);
        voiceConnection.invoke("JoinVoiceChannel", voiceChannelId, userId)
            .then(() => console.log("✅ Joined voice channel"))
            .catch(err => console.error("❌ Error joining:", err));
    }

    // Function to leave voice channel
    function leaveVoiceChannel(userId) {
        voiceConnection.invoke("LeaveVoiceChannel", userId)
            .then(() => console.log("✅ Left voice channel"))
            .catch(err => console.error("❌ Error leaving:", err));
    }

    // Listen for users joining
    voiceConnection.on("UserJoinedVoice", (voiceChannelId, users) => {
        console.log(`📢 UserJoinedVoice event for channel ${voiceChannelId}:`, users);
        updateVoiceChannelUI(voiceChannelId, users);
    });

    // Listen for users leaving
    voiceConnection.on("UserLeftVoice", (voiceChannelId, users) => {
        console.log(`📢 UserLeftVoice event for channel ${voiceChannelId}:`, users);
        updateVoiceChannelUI(voiceChannelId, users);
    });

    // Update UI to show users in voice channel
    function updateVoiceChannelUI(voiceChannelId, users) {
        const container = document.querySelector(`#voice-channel-${voiceChannelId} .voice-users-container`);

        if (!container) {
            console.error(`❌ Container not found for voice channel ${voiceChannelId}`);
            return;
        }

        // Clear existing users
        container.innerHTML = '';

        // Add each user
        users.forEach(user => {
            const userDiv = document.createElement('div');
            userDiv.className = 'voice-user';

            // Create avatar
            const avatar = document.createElement('div');
            avatar.className = 'voice-user-avatar';

            if (user.avatarURL && user.avatarURL !== '') {
                const img = document.createElement('img');
                img.src = user.avatarURL;
                img.alt = user.username;
                avatar.appendChild(img);
            } else {
                // Show first letter of username if no avatar
                avatar.textContent = user.username.substring(0, 1).toUpperCase();
            }

            // Create username span
            const nameSpan = document.createElement('span');
            nameSpan.className = 'voice-user-name';
            nameSpan.textContent = user.username;

            // Assemble
            userDiv.appendChild(avatar);
            userDiv.appendChild(nameSpan);
            container.appendChild(userDiv);
        });

        console.log(`✅ Updated UI for voice channel ${voiceChannelId} with ${users.length} users`);
    }

    // Handle page unload - leave voice channel
    window.addEventListener('beforeunload', () => {
        const userId = @ViewBag.UserProfile.Id;
        leaveVoiceChannel(userId);
    });
</script>